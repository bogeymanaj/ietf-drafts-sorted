<?xml version="1.0" encoding="UTF-8"?>

<!-- NOTE to anyone trying to compile this: current xml2rfc will not
	  process it with "strict" -- produces all sorts of spurious
	  errors about improperly-organized front/ middle/ back parts --> 



<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [

<!ENTITY rfc3865 PUBLIC ''
   'http://xml.resource.org/public/rfc/bibxml/reference.RFC.3865.xml'>
<!ENTITY rfc2645 PUBLIC ''
   'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2645.xml'>
<!ENTITY rfc2852 PUBLIC ''
   'http://xml.resource.org/public/rfc/bibxml/reference.RFC.2852.xml'>
<!ENTITY rfc4141 PUBLIC ''
   'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4141.xml'>
<!ENTITY rfc4871 PUBLIC ''
   'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4871.xml'>
<!ENTITY rfc4880 PUBLIC ''
   'http://xml.resource.org/public/rfc/bibxml/reference.RFC.4880.xml'>
<!ENTITY rfc5672 PUBLIC ''
   'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5672.xml'>
<!ENTITY rfc5751 PUBLIC ''
   'http://xml.resource.org/public/rfc/bibxml/reference.RFC.5751.xml'>

]>

<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<?rfc compact="yes"?>
<?rfc subcompact="no" ?>

<?rfc toc="yes"?>
<?rfc tocompact="yes"?>
<?rfc tocdepth="3"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes"?>

<!-- Expand crefs and put them inline -->
<?rfc comments='yes' ?>
<?rfc inline='yes' ?>  

<rfc docName="draft-ietf-yam-rfc4409bis-03" ipr="trust200902"
     obsoletes='4409'  category='std'>
   
  <front>
    <title abbrev="Message Submission for Mail">
      Message Submission for Mail</title>
<author initials="R." surname="Gellens" fullname="Randall Gellens">
  <organization>QUALCOMM Incorporated</organization>
  <address>
    <postal>
      <street>5775 Morehouse Drive</street>
      <city>San Diego</city> <region>CA</region> <code>92121-2779</code>
      <country>USA</country> </postal>
      <!-- <phone>?? </phone> -->
    <email>rg+ietf@qualcomm.com</email>
  </address>
  </author>
  <author initials="J.C." surname="Klensin" fullname="John C Klensin">
  <organization/>
  <address>
    <postal>
      <street>1770 Massachusetts Ave, #322</street>
      <city>Cambridge</city> <region>MA</region> <code>02140</code>
      <country>USA</country> </postal>
    <phone>+1 617 491 5735 </phone>
    <email>john-ietf@jck.com</email>
  </address>
  </author>

  <date month="September" year="2011" day="2"/>

  <area>Applications</area>
  <workgroup>YAM</workgroup>
  
    <keyword>Text</keyword>
    <keyword>Internationalization</keyword>
    <keyword>ASCII</keyword>
    <keyword>Unicode</keyword>
    <keyword>UTF-8</keyword>
    <abstract>
      <t>This memo splits message submission from message relay,
		 allowing each service to operate according to its own rules
		 (for security, policy, etc.), and specifies what actions are
		 to be taken by a submission server.</t>
	  <t>Message relay is unaffected, and continues to use SMTP
		 over port 25.</t>
	  <t>When conforming to this document, message submission uses
		 the protocol specified here, normally over port 587. </t>
	  <t>This separation of function offers a number of benefits,
		 including the ability to apply specific security or policy
		 requirements.</t>
    </abstract>
  </front>

********************
Comments:
        

  <middle>
  <section title="Introduction">
	 <t>SMTP <xref target="SMTP-MTA"/> was defined as a message
		*transfer* protocol, that is, a 
		means to route (if needed) and deliver finished (complete)
		messages.</t>
	 <t>Message Transfer Agents (MTAs) are not supposed to alter the
		message text, except to add 'Received', 'Return-Path', and
		other header fields as required by [SMTP-MTA].
        However, SMTP is now also widely used as a message
		*submission* protocol, that is, a means for Message User
		Agents (MUAs) to introduce new messages into the MTA routing
		network.  The process that accepts message submissions from
		MUAs is termed a Message Submission Agent (MSA).</t>
	 <t>In order to permit unconstrained communications, SMTP is not
		often authenticated during message relay.</t>
	 <t>Authentication and authorization of initial submissions have
		become increasingly important, driven by changes in security
		requirements and rising expectations that submission servers
		take responsibility for the message traffic they originate.</t>
     <t>   For example, due to the prevalence of machines that have worms,
   viruses, or other malicious software that generate large amounts of
   spam, many sites now prohibit outbound traffic on the standard SMTP
   port (port 25), funneling all mail submissions through submission
   servers.</t>

   <t> In addition to authentication and authorization issues, messages
   being submitted are in some cases finished (complete) messages, and
   in other cases are unfinished (incomplete) in one or more aspects.
   Unfinished messages may need to be completed to ensure they conform
   to the Message Format specification
   <xref target="MESSAGE-FORMAT"/>, and related requirements.  For example, the
   message may lack a proper 'Date' header field, and domains might not
   be fully qualified.  In some cases, the MUA may be unable to generate
   finished messages (e.g., it might not know its time zone).  Even when
   submitted messages are complete, local site policy may dictate that
   the message text be examined or modified in some way, e.g., to
   conceal local name or address spaces.  Such completions or
   modifications have been shown to cause harm when performed by
   downstream MTAs -- that is, MTAs after the first-hop submission MTA
   -- and are in general considered to be outside the province of
   standardized MTA functionality.</t>

   <t>Separating messages into submissions and transfers allows
	  developers and network administrators to more easily do the
	  following:
	  <list style="symbols">
		 <t>Implement security policies and guard against unauthorized mail
       relaying or injection of unsolicited bulk mail</t>
	     <t>Implement authenticated submission, including off-site submission
       by authorized users such as travelers</t>
	     <t>Separate the relevant software code differences, thereby making
       each code base more straightforward and allowing for different
       programs for relay and submission</t>
	     <t>Detect configuration problems with a site's mail
			clients</t>
		 <t>Provide a basis for adding enhanced submission services.</t>
	   </list></t>

   <t>This memo describes a low-cost, deterministic means for messages to
   be identified as submissions, and specifies what actions are to be
   taken by a submission server.</t>

   <section title="Discussion List">
	  <t><cref>RFC Editor: Please remove this section before
		 publication.</cref></t>
	  <!--     Public comments should be sent to
		the IETF Submit mailing list, <ietf-submit@imc.org>.  To subscribe,
		send a message containing SUBSCRIBE to
		<ietf-submit-request@imc.org>.  This list will remain active
	    after publication. 
		Private comments may be sent to the authors. -->
	  <t>This document is being discussed in the IETF YAM Working
		 Group.</t>
   </section>

   <section title="Note to IESG and/or Document Shepherd">
	  <t><cref>RFC Editor: Please remove this section before
		 publication.</cref></t>
	  <t>RFC 4409 was published in April 2006, so the "time in place"
		 requirement of RFC 2026 has been satisfied.</t>
	  <t>Message Submission on port 587 has seen significant deployment over
		   the past 8-10 years, becoming widespread in the past 2-3 years.
		   There are several reasons for this, such as decisions by many ISPs
		   and organizations in general to block outbound port 25 (except by
		   their own border MTAs), and consequently to support 587 with
		   authentication, as well as recognition of the need to apply different
		   policies to submission and relay.</t>
	  <t>The effort required to reissue and process this document is justified by
		 the need to update and clarify several references and by
		 additional clarifying text to support email
		 internationalization work.</t>
   </section>
		 
   </section>

   <section title="Document Information">
	  <section title="Definitions of Terms Used in This Memo">
   <t>Many of the concepts and terms used in this document are defined in
   [SMTP-MTA]; familiarity with those documents is assumed here.</t>

   <t>Fully-Qualified
	  <vspace blankLines="1"/>
   Containing or consisting of a domain that can be globally resolved
   using the Domain Name Service; that is, not a local alias or partial
   specification.</t>

   <t>Message Submission Agent (MSA)
	  <vspace blankLines="1"/>
   A process that conforms to this specification.  An MSA acts as a
   submission server to accept messages from MUAs, and either delivers
   them or acts as an SMTP client to relay them to an MTA.</t>

   <t>Message Transfer Agent (MTA)
	  <vspace blankLines="1"/>
   A process that conforms to [SMTP-MTA].  An MTA acts as an SMTP server
   to accept messages from an MSA or another MTA, and either delivers
   them or acts as an SMTP client to relay them to another MTA.</t>

   <t>Message User Agent (MUA)
	  <vspace blankLines="1"/>
   A process that acts (often on behalf of a user and with a user
   interface) to compose and submit new messages, and process delivered
   messages.
	  <vspace blankLines="1"/>
   For delivered messages, the receiving MUA may obtain and process the
   message according to local conventions or, in what is commonly
   referred to as a split-MUA model, Post Office Protocol [POP3] or IMAP
   [IMAP4] is used to access delivered messages, whereas the protocol
   defined here (or SMTP) is used to submit messages.</t>
  </section>

  <section title="Conventions Used in This Document" anchor="DocConventions">
   <t>Examples use the 'example.net' domain.</t>

   <t>The key words "MUST", "MUST NOT", "SHOULD", "SHOULD NOT", and "MAY"
   in this document are to be interpreted as defined in
   <xref target="KEYWORDS"/>.</t>
   </section>
   </section>

   <section title="Message Submission" anchor="MessageSubmission">
	  <section title="Submission Identification">
		 <t>Port 587 is reserved for email message submission as specified in
   this document.  Messages received on this port are defined to be
   submissions.  The protocol used is ESMTP <xref target="SMTP-MTA"/>, with
   additional restrictions or allowances as specified here.</t>

         <t>Although most email clients and servers can be configured to use port
   587 instead of 25, there are cases where this is not possible or
   convenient.  A site MAY choose to use port 25 for message submission,
   by designating some hosts to be MSAs and others to be MTAs.</t>
      </section>

	  <section title="Message Rejection and Bouncing">

		 <t>MTAs and MSAs MAY implement message rejection rules that rely in part
   on whether the message is a submission or a relay.</t>
         <t>For example, some sites might configure their MTAs to reject all RCPT
   commands for messages that do not reference local users, and
   configure their MSA to reject all message submissions that do not
   come from authorized users, with authorization based either on
   authenticated identity or the submitting endpoint being within a
   protected IP environment.</t>

        <t>NOTE:  It is better to reject a message than to risk sending one that
   is damaged.  This is especially true for problems that are
   correctable by the MUA, for example, an invalid 'From' field.</t>

        <t>If an MSA is not able to determine a return path to the submitting
   user, from a valid MAIL FROM, a valid source IP address, or based on
   authenticated identity, then the MSA SHOULD immediately reject the
   message.  A message can be immediately rejected by returning a 550
   code to the MAIL command.</t>

       <t>Note that a null return path, that is, MAIL FROM:&lt;&gt;, is permitted and
   MUST NOT in itself be cause for rejecting a message.  (MUAs need to
   generate null return-path messages for a variety of reasons,
   including disposition notifications.)</t>

       <t>Except in the case where the MSA is unable to determine a valid
   return path for the message being submitted, text in this
   specification that instructs an MSA to issue a rejection code MAY be
   complied with by accepting the message and subsequently generating a
   bounce message.  (That is, if the MSA is going to reject a message
   for any reason except being unable to determine a return path, it can
   optionally do an immediate rejection or accept the message and then
   mail a bounce.)</t>

       <t>NOTE:  In the normal case of message submission, immediately
   rejecting the message is preferred, as it gives the user and MUA
   direct feedback.  To properly handle delayed bounces, the client MUA
   needs to maintain a queue of messages it has submitted, and match
   bounces to them.  Note that many contemporary MUAs do not have this
   capability.</t>
      </section>

      <section title="Authorized Submission" anchor="AuthorizedSubmission">

         <t>Numerous methods have been used to ensure that only authorized users
   are able to submit messages.  These methods include authenticated
   SMTP, IP address restrictions, secure IP and other tunnels, and prior
   POP authentication.</t>

         <t>Authenticated SMTP <xref target="SMTP-AUTH"/> has seen
			widespread deployment.  It 
   allows the MSA to determine an authorization identity for the message
   submission, one that is not tied to other protocols.</t>

         <t>IP address restrictions are very widely implemented, but do not allow
   for travelers and similar situations, and can be easily spoofed
   unless all transport paths between the MUA and MSA are
   trustworthy.</t>

         <t>Secure IP <xref target="IPSEC"/>, and other encrypted and
			authenticated tunneling 
   techniques, can also be used and provide additional benefits of
   protection against eavesdropping and traffic analysis.</t>

         <t>Requiring a POP <xref target="POP3"/> authentication
			(from the same IP address) 
   within some amount of time (e.g., 20 minutes) prior to the start of a
   message submission session has also been used, but this does impose
   restrictions on clients as well as servers, which may cause
   difficulties.  Specifically, the client must do a POP authentication
   before an SMTP submission session, and not all clients are capable
   and configured for this.  Also, the MSA must coordinate with the POP
   server, which may be difficult.  There is also a window during which
   an unauthorized user can submit messages and appear to be a
   previously authorized user.  Since it is dependent on the MUA's IP
   addresses, this technique is substantially as subject to IP address
   spoofing as validation based on known IP addresses alone (see
   above).</t>
   </section>
   </section>

   <section title="Mandatory Actions">
	  <t>An MSA MUST do all of the following:</t>

	  <section title="General Submission Rejection Code">
		 <t>Unless covered by a more precise response code, response code 554 is
   to be used to reject a MAIL, RCPT, or DATA command that contains
   something improper.</t>
      </section>

	  <section title="Ensure All Domains Are Fully-Qualified">
		 <t>The MSA MUST ensure that all domains in the SMTP envelope are fully-
			qualified.</t>
		 <t>If the MSA examines or alters the message text in any way, except to
		   add trace header fields [SMTP-MTA], it MUST ensure that all domains
		   in address header fields are fully-qualified.</t>

		<t>Reply code 554 is to be used to reject a MAIL, RCPT, or DATA command
		   that contains improper domain references.</t>

		<t>A frequent local convention is to accept single-level domains (e.g.,
		   'sales') and then to expand the reference by adding the remaining
		   portion of the domain name (e.g., to 'sales.example.net').  Local
		   conventions that permit single-level domains SHOULD reject, rather
		   than expand, incomplete multi-level domains (e.g., 'squeaky.sales'),
		   since such expansion is particularly risky.</t>
      </section>

	  <section title="Require Authentication">
		 <t>The MSA MUST by default issue an error response to the MAIL command
		   if the session has not been authenticated using [SMTP-AUTH], unless
		   it has already independently established authentication or
		   authorization (such as being within a protected
		   subnetwork).</t>
		<t> <xref target="AuthorizedSubmission"/> discusses
		   authentication mechanisms. </t>
		<t>Reply code 530 <xref target="SMTP-AUTH"/> is used for this
		   purpose.</t>
	  </section>
	  </section>

	  <section title="Recommended Actions">
		 <t>The MSA SHOULD do all of the following:</t>

		 <section title="Enforce Address Syntax">
			<t>An MSA SHOULD reject messages with illegal syntax in a sender or
			   recipient SMTP envelope address.</t>
			<t>If the MSA examines or alters the message text in way, except to add
			   trace header fields, it SHOULD reject messages with illegal address
			   syntax in address header fields.</t>
			<t>Reply code 501 is to be used to reject a MAIL or RCPT command that
			   contains a detectably improper address.</t>

			<t>When addresses are resolved after submission of the
			   message body, reply code 554 (with a suitable enhanced
			   status code from <xref target="SMTP-CODES"/>) is used
			   after end-of-data, if the message contains invalid
			   addresses in the header.</t>
		</section>

		<section title="Log Errors" anchor="LogErrors">
		   <t>The MSA SHOULD log message errors, especially apparent
			  misconfigurations of client software.</t>

		   <t>It can be very helpful to notify the administrator when problems are
			   detected with local mail clients.  This is another advantage of
			   distinguishing submission from relay: system administrators might be
			   interested in local configuration problems, but not in client
			   problems at other sites.</t>

			<t>Note that it is important to impose limits on such logging to prevent
			   certain forms of denial of service (DoS) attacks.</t>
		</section>

		<section title="Apply Shorter Timeouts" anchor="ShortTimeout">
		   <t>The timeouts specified in Section 4.5.3.2 of
			  <xref target="SMTP-MTA">RFC 5321</xref> are designed to
			  deal with the many types of situations that can be
			  encountered on the public Internet.  The relationship
			  among clients and servers corresponding to this
			  specification is typically much closer and more
			  predictable.  Submission clients behave differently
			  from relay client in some areas, especially tolerance for time-
			  outs.  In practice, message submission clients tend to have short
			  time-outs (perhaps 2-5 minutes for a reply to any command).
			  Submission servers SHOULD respond to any command (even 
			  DATA) in fewer than 2 minutes.
			  <!-- new text, 20110726 -->
		      When the submission server has a close administrative
			  and/or network relationship with the submission
			  client(s) --e.g., with a webmail interface calling on a
			  tightly-bound submission server-- mutual agreement on
			  much shorter timeouts MAY be appropriate. </t> 
		</section>
		</section>

	<section title="Optional Actions">
	   <t>The MSA MAY do any of the following:</t>

	   <section title="Enforce Submission Rights">
		  <t>The MSA MAY issue an error response to a MAIL command if the address
		   in MAIL FROM appears to have insufficient submission rights, or is
		   not authorized with the authentication used (if the session has been
		   authenticated).</t>

		<t>Reply code 550 with an appropriate enhanced status code per
		   <xref target="SMTP-CODES"/>, such as 5.7.1, is used for
		   this purpose.</t>
		</section>

		<section title="Enforce Permissions">
		   <t>The MSA MAY issue an error response to a RCPT command if inconsistent
			   with the permissions given to the user (if the session has been
			   authenticated).</t>

			<t>Reply code 550 with an appropriate enhanced status
			   code per <xref target="SMTP-CODES"/>, such as 5.7.1,
			   is used for this purpose.</t>
		</section>

		<section title="Check Message Data">
		   <t>The MSA MAY issue an error response to the DATA command or send a
			   failure result after end-of-data if the submitted message is
			   syntactically invalid, or seems inconsistent with permissions given
			   to the user (if known), or violates site policy in
			   some way.</t>
		   <t>Reply code 554 is used for syntactic problems in the
			  data.  Reply code 501 is used if the command itself is
			  not syntactically valid.  Reply code 550 with an
			  appropriate enhanced status code
			  per <xref target="SMTP-CODES"/> (such as 5.7.1) is used
			  to reject based on the submitting user.  Reply code 550
			  with an appropriate enhanced status code (such as
			  5.7.0) is used if the message violates site policy.</t> 
		</section>

		<section title="Support for the Postmaster Address">
		   <t>If appropriate under local conditions and to facilitate
			  conformance with the "postmaster" requirements of
			  <xref target="SMTP-MTA"/>, the MSA MAY permit a reduced
			  degree of authentication for mail addressed to the 
			  "postmaster" (or one of its alternate spelling forms, see
			  <xref target="SMTP-MTA"/>), in one or more domains, as compared to
			  requirements 
			  enforced for other addresses.  Among other benefits, this provides an
			  address of last resort that can be used by authorized users to report
			  problems that otherwise prevent them from submitting mail.</t>
		</section>

		<section title="Adjust Character Encodings" anchor="CharEncode">
		   <t>Subject to limits imposed by other protocols and
			  specifications, the MSA MAY convert among character sets
			  or string encodings to improve message usefulness, 
			  likelihood of delivery, or conformance with other
			  specifications or recommendations.  Such conversions MAY
			  include, when necessary, replacement of addresses whose
			  encoding does not conform to RFC 5321 with ones that do,
			  using information available out of band.</t>
		</section>
    </section>

	<section title="Interaction with SMTP Extensions" anchor="SMTP-Interaction">
	   <t>The following table lists standards-track and
		   Experimental SMTP extensions whose documents do not
		   explicitly specify their applicability to this protocol.
		   Listed are the EHLO keyword, name, an indication as to the
		   use of the extension on the submit port, and a 
		   reference:</t>

		<texttable anchor="ExtTable">
		   <preamble>[[RFC Editor: Please see if you can do something
			  with the formatting of this table that results in a more
			  readable appearance.  Consult the document editors as
			  needed.]]</preamble>
		   <ttcol align='left'>Keyword</ttcol>
		   <ttcol align='left'>Name</ttcol>
		   <ttcol align='center'>Submission</ttcol>
		   <ttcol align='left'>Reference</ttcol>
<c>PIPELINING</c> <c>Pipelining</c><c>SHOULD</c> <c><xref target="PIPELINING"/></c>
<c>ENHANCEDSTATUSCODES</c> <c>Enhanced Status Codes</c> <c>SHOULD</c> <c><xref target="CODES-EXTENSION"/></c>
<c>ETRN</c> <c>Extended Turn</c> <c>MUST NOT</c> <c><xref target="ETRN"/></c>
<c> ...</c> <c>Extended Codes</c> <c>SHOULD</c> <c><xref target="SMTP-CODES"/></c>
<c>DSN</c> <c>Delivery Status Notification</c> <c>SHOULD</c> <c><xref target="DSN"/></c>
<c>SIZE</c> <c>Message size</c> <c>MAY</c> <c><xref target="SIZE"/></c>
<c>...</c> <c>521 reply code</c> <c>MUST NOT</c> <c><xref target="REPLY-521"/></c>
<c>CHECKPOINT</c> <c>Checkpoint/Restart</c> <c>MAY</c> <c><xref target="CHECKPOINT"/></c>
<c>BINARYMIME</c> <c>Binary MIME</c> <c>MAY</c> <c><xref target="CHUNKING"/></c>
<c>CHUNKING</c> <c>Chunking</c> <c>MAY</c> <c><xref target="CHUNKING"/></c>
<c>8BITMIME</c> <c>Use 8-bit data</c> <c>SHOULD</c> <c><xref target="RFC6152"/></c>
<c>AUTH</c> <c>Authentication</c> <c>MUST</c> <c><xref target="SMTP-AUTH"/></c>
<c>STARTTLS</c> <c>Start TLS</c> <c>MAY</c> <c><xref target="Start-TLS"/></c>
<c>NO-SOLICITING</c> <c>Notification of no soliciting</c> <c>MAY</c> <c><xref target="RFC3865"/></c>
<c>MTRK</c> <c>Message Tracking</c> <c>MAY</c> <c><xref target="Msg-Track"/></c>
<c>ATRN</c> <c>On-Demand Relay</c> <c>MUST NOT</c> <c><xref target="RFC2645"/></c>
<c>DELIVERBY</c> <c>Deliver By</c> <c>MAY</c> <c><xref target="RFC2852"/></c>
<c>CONPERM</c> <c>Content Conversion Permission</c> <c>MAY</c> <c><xref target="RFC4141"/></c>
<c>CONNEG</c> <c>Content Conversion Negotiation</c> <c>MAY</c> <c><xref target="RFC4141"/></c>

<!-- Template:
    <c>K</c> <c>TBS</c> <c>S</c> <c><xref target=""/></c>  -->

    </texttable>
 
		 
    <t>Future SMTP extensions SHOULD explicitly specify if they are valid on
   the Submission port.</t>

    <t>Some SMTP extensions are especially useful for message
	   submission:</t>

    <t>Extended Status Codes <xref target="SMTP-CODES"/> SHOULD be
	   supported and used according
	   to <xref target="CODES-EXTENSION"/>.   This permits the MSA to
	   notify the 
	   client of specific configuration or other problems in more detail
	   than the response codes listed in this memo.  Because some rejections
	   are related to a site's security policy, care should be used not to
	   expose more detail to unauthenticated senders than is
	   needed</t>

	<t> <xref target="PIPELINING"/> SHOULD be supported by the
	   MSA.</t>

	<t><xref target="SMTP-AUTH"/> allows the MSA to validate the
	   authority and determine the identity of the submitting user
	   and MUST be supported by the MSA.</t>

	<t><xref target="Start-TLS"/> is the most widely used mechanism
	   at the time this is written that allows the MUA and MSA to
	   protect message submission integrity and privacy.</t>

	<t>Any references to the DATA command in this memo also refer to
	   any substitutes for DATA, such as the BDAT command used with
	   <xref target="CHUNKING"/>.</t>

   </section>

   <section title="Message Modifications" anchor="MsgMods">
	  <t>Sites MAY modify submissions to ensure compliance with
		 standards and site policy.  This section describes a number
		 of such modifications that are often considered useful.</t>

	  <t>NOTE:  As a matter of guidance for local decisions to implement
	   message modification, a paramount rule is to limit such actions to
	   remedies for specific problems that have clear solutions.  This is
	   especially true with address elements.  For example, indiscriminately
	   appending a domain to an address or element that lacks one typically
	   results in more broken addresses.  An unqualified address must be
	   verified to be a valid local part in the domain before the domain can
	   be safely added.</t>

	 <t>Any message forwarded or delivered by the MSA MUST conform to the
	   requirements of <xref target="SMTP-MTA"/>
	   and <xref target="MESSAGE-FORMAT"/> or the requirements
	   permited by extensions that are supported by the MSA and
	   accepted by the next-hop server.</t>

	<t>Message modification can affect the validity of an existing message
      signature, such as by 
	   <xref target="DKIM">DKIM</xref>,
	   <xref target="RFC4880">PGP</xref>, or
	   <xref target="RFC5751">S/MIME</xref>,
      and can render the  signature invalid.  This, in turn, can affect
      message handling by later receivers, such as filtering engines that
      consider the presence or absence of a valid signature.</t>

	<section title="Add 'Sender'">
	   <t>The MSA MAY add or replace the 'Sender' field, if the identity of the
		  sender is known and this is not given in the 'From'
		  field.</t>
	   <t>The MSA MUST ensure that any address it places in a 'Sender' field is
		  in fact a valid mail address.</t>
	  </section>

	  <section title="Add 'Date'">
		 <t> The MSA MAY add a 'Date' field to the submitted message,
			if it lacks it, or correct the 'Date' field if it does
			not conform to <xref target="MESSAGE-FORMAT"/> syntax.</t>
	  </section>

	  <section title="Add 'Message-ID'">
		 <t>The MSA SHOULD add or replace the 'Message-ID' field, if
			it lacks it, or it is not valid syntax (as defined by
			<xref target="MESSAGE-FORMAT"/>).  Note that a number of
			clients still do not generate Message-ID fields.</t>
	  </section>

	  <section title="Transfer Encode">
		 <t>The MSA MAY apply transfer encoding to the message according to MIME
			conventions, if needed and not harmful to the MIME type.</t>
	  </section>

	  <section title="Sign the Message">
		 <t>The MSA MAY (digitally) sign or otherwise add authentication
   information to the message.</t>
	  </section>

	  <section title="Encrypt the Message">
		 <t>The MSA MAY encrypt the message for transport to reflect
			organizational policies.</t>

		 <t>NOTE:  To be useful, the addition of a signature and/or encryption by
		   the MSA generally implies that the connection between the MUA and MSA
		   must itself be secured in some other way, for example, by operating
		   inside of a secure environment, by securing the submission connection
		   at the transport layer, or by
		   using an <xref target="SMTP-AUTH"/> mechanism that
		   provides for session integrity.</t>
	  </section>

	  <section title="Resolve Aliases" anchor="ResolveAliases">
		 <t>The MSA MAY resolve and rewrite aliases (e.g., CNAME records) for
			domain names, in the 
		   SMTP envelope and/or in address fields of the header, subject
		   to local policy.</t>

		<t>NOTE: <xref target="SMTP-MTA">SMTP</xref> prohibits the use
		   of domain name aliases in addresses and the session-opening
		   announcement.  As with other SMTP requirements, RFC 5321
		   effectively prohibits an MSA from forwarding such messages
		   into the public Internet.  Nonetheless, unconditionally
		   resolving aliases could be harmful.  For 
		   example, if www.example.net and ftp.example.net are both aliases for
		   mail.example.net, rewriting them could lose useful information.</t>
      </section>
			   
	  <section title="Header Rewriting">
		 <t>The MSA MAY rewrite local parts and/or domains in the SMTP envelope,
		   and optionally in address fields of the header, according to local
		   policy.  For example, a site may prefer to rewrite 'JRU' as
		   'J.Random.User' in order to hide login names, and/or to rewrite
		   'squeaky.sales.example.net' as 'zyx.example.net' to hide machine
		   names and make it easier to move users.</t>
		<t>However, only addresses, local-parts, or domains which match specific
		   local MSA configuration settings should be altered.  It would be very
		   dangerous for the MSA to apply data-independent rewriting rules, such
		   as always deleting the first element of a domain name.  So, for
		   example, a rule that strips the left-most element of the domain, if
		   the complete domain matches '*.foo.example.net', would be
		   acceptable.</t>

		<t>The MSA MUST NOT rewrite a forward-pointing (destination)
		   address in a way that violates the constraints
		   of <xref target="SMTP-MTA"/> on modifications of
		   local-parts.  Addressing and encoding changes carried out
		   in conjunction with the action
		   of <xref target="CharEncode"/> do not violate this
		   principle if the MSA has sufficient information available
		   to successfully and accurately apply the substitution.</t>
	  </section>
	  </section>
	  
	  <section title="Security Considerations">
		 <t>Separation of submission and relay of messages allows a site to
   implement different policies for the two types of services, including
   requiring use of additional security mechanisms for one or both.  It
   can do this in a way which is simpler, both technically and
   administratively.  This increases the likelihood that policies will
   be applied correctly.</t>

         <t> Separation also can aid in tracking and preventing unsolicited bulk
   email.</t>

         <t> For example, a site could configure its mail servers such that the
   MSA requires authentication before accepting a message, and the MTA
   rejects all RCPT commands for non-local users.  This can be an
   important element in a site's total email security policy.</t>

         <t> If a site fails to require any form of authorization for message
   submissions (see <xref target="AuthorizedSubmission" /> for discussion), it is allowing open use
   of its resources and name; unsolicited bulk email can be injected
   using its facilities.</t>

         <t> <xref target="MessageSubmission" /> includes further discussion of issues with some
   authentication methods.</t>

         <t> <xref target="LogErrors" /> includes a cautionary note that unlimited logging can
   enable certain forms of denial of service attacks.</t>

   </section>

   <section title="IANA Considerations" anchor="IANAConsid">
	  <!-- Version up to version 02...
	  <t> The table in <xref target="ExtTable"/> has been corrected
		 (reference for NO-SOLICITING) and extended (ATRN, DELIVERBY,
		 CONPEM, and CONNEG).  The registry should be updated to
		 reflect the changed and new entries.  Entries in the
		 registry that do not appear in the table above are correct
		 and should not be altered.</t>
	  <t>The registration records for Port 587 should be updated to
		 point to this document rather than RFC 4409.</t>  -->

	  <!-- Version in -03 per SM email 20110824 15:59 -0700 -->
	  <t> The entries in <xref target="ExtTable"/> have been
		 corrected (reference for NO-SOLICITING) and extended (ATRN,
		 DELIVERBY, CONPERM, and CONNEG).  The SMTP Service 
		Extensions registry should be updated to reflect the changed and new
		entries.  Entries in the registry that do not appear in the table above
		are correct and should not be altered.</t>
	 <t>The entry in the SMTP Service Extensions registry for RFC
		4409 should be updated to reference this document.  The
		original reference for Submit (RFC 2476), which should have
		been corrected earlier, should be updated to point to this
		document.</t>
	 <t>The entry in the Service Name and Transport Protocol Port
		Number Registry for port 587 should be updated to point to
		this document.</t>

	  <t><cref>Note to RFC Editor: please change all instances of
		 "should be updated" above to "has been updated" after the
		 changes are made.</cref></t>
   </section>

   <section title="Acknowledgments">
	  <t> The preparation and development of the current version of
		 this specification was stimulated by discussions in the IETF
		 YAM and EAI Working Groups.  Dave Crocker, Subramanian
		 Moonesamy, Barry Leiba, John Levine, and others provide
		 text that appeared in this document or versions leading up to
		 it.</t>
	  
	  <t>Nathaniel Borenstein and Barry Leiba were instrumental in the
		 development of RFC 4409, the update to RFC 2476.</t>

	  <t>The original memo (RFC 2476) was developed in part based on comments
		   and discussions which took place on and off the IETF-Submit mailing
		   list.  The help of those who took the time to review that document
		   and make suggestions is appreciated, especially that of Dave Crocker,
		   Ned Freed, Keith Moore, John Myers, and Chris Newman.</t>
	  <t>Special thanks to Harald Alvestrand, who got this effort
		 started.</t>
   </section>

   </middle>

   <back>

	  
<references title="Normative References">

   <reference anchor="KEYWORDS">
      <front>
         <title>Key words for use in RFCs to Indicate
                     Requirement Levels</title>
         <author initials="S." surname="Bradner"></author>
         <date month="March" year="1997" />
      </front>
      <seriesInfo name="RFC" value="2119"/>
	  <seriesInfo name="BCP" value="14"/>
    </reference>

   <reference anchor="SMTP-MTA">
      <front>
         <title>Simple Mail Transfer Protocol</title>
         <author initials="J." surname="Klensin" ></author>
         <date month="October" year="2008" />
      </front>
	  <seriesInfo name="RFC" value="5321"/>
      <!-- Postel, J., "Simple Mail Transfer Protocol", STD
                     10, RFC 821, August 1982.

                     Partridge, C., "Mail routing and the domain
                     system", STD 10, RFC 974, January 1986.

                     Braden, R., "Requirements for Internet Hosts -
                     Application and Support", STD 3, RFC 1123, October
                     1989.

                     Klensin, J., "Simple Mail Transfer Protocol", RFC
                     2821, April 2001.  -->
	   <!-- RFC Editor: -->
	   <annotation>An update to RFC 5321 is in progress.  This
		  document should be checked just before publication to be
		  sure that references are up-to-date and/or this comment is
		  modified as needed.  If the update is issued at Full
		  Standard, the reference to RFC 5321 should also be removed
		  from the RFC 4897 statement in Appendix B.</annotation>
    </reference>		

   <reference anchor="SMTP-AUTH"> 
      <front>
         <title>SMTP Service Extension for Authentication</title>
         <author initials="R." surname="Siemborski" role="editor"></author>
         <author initials="A." surname="Melnikov" role="editor"></author>
         <date month="July" year="2007" />
      </front>
      <seriesInfo name="RFC" value="4954"/>
    </reference>
    
  </references>  <!-- End of Normative References -->
	 

  <references title="Informative References">

		&rfc3865;
		&rfc2645;
		&rfc2852;
		&rfc4141;
		&rfc4880;
		&rfc5751;




   <reference anchor="MESSAGE-FORMAT">
      <front>
         <title>Internet Message Format</title>
         <author initials="P." surname="ResnicK" role="editor"></author>
         <date month="October" year="2008" />
      </front>
	  <seriesInfo name="RFC" value="5322"/>
       <!-- Crocker, D., "Standard for the format of ARPA
                     Internet text messages", STD 11, RFC 822, August
                     1982.

                     Braden, R., "Requirements for Internet Hosts -
                     Application and Support", STD 3, RFC 1123, October
                     1989.

                     Resnick, P., "Internet Message Format", RFC 2822,
                     April 2001. -->	  
	   <!-- RFC Editor: -->
	   <annotation>An update to RFC 5322 is in progress.  This
		  document should be checked just before publication to be
		  sure that references are up-to-date and/or this comment is
		  modified as needed.</annotation>
    </reference>
		

  <reference anchor="DKIM" >
      <front>
        <title>DomainKeys Identified Mail (DKIM) Signatures</title>
		<author initials="E." surname="Allman"></author>
		<author initials="J." surname="Callas"></author>
		<author initials="M." surname="Delany"></author>
		<author initials="M." surname="Libbey"></author>
		<author initials="J." surname="Fenton"></author>
		<author initials="M." surname="Thomas"></author>
		<date month="May" year="2007"/>
	  </front>
	  <seriesInfo name="RFC" value="4871"/>
	  <annotation>[[RFC Editor: Please change to reference the RFC
		 associated with draft-ietf-dkim-rfc4871bis if it is published
		 before this or consult with editors, WG Chairs, and
		 AD.  Neither a hold nor a "work in progress" reference are
		 needed here.]]</annotation>
   </reference>
		
   <reference anchor="REPLY-521">
      <front>
         <title>SMTP 521 Reply Code</title>
         <author initials="A." surname="Durand"></author>
         <author initials="F." surname="Dupont"></author>
         <date month="September" year="1995" />
      </front>
      <seriesInfo name="RFC" value="1846"/>
    </reference>

   <reference anchor="RFC6152">
      <front>
         <title>SMTP Service Extension for 8-bit MIME transport</title>
         <author initials="J." surname="Klensin" ></author>
         <author initials="N." surname="Freed"></author>
         <author initials="M." surname="Rose"></author>
         <author initials="E." surname="Stefferud"></author>
         <author initials="D." surname="Crocker"></author>
         <date month="March" year="2011" />
      </front>
      <seriesInfo name="RFC" value="6152"/>
    </reference>

   <reference anchor="CHECKPOINT">
      <front>
         <title>SMTP
                     Service Extension for Checkpoint/Restart</title>
         <author initials="D." surname="Crocker"></author>
         <author initials="N." surname="Freed"></author>
         <author initials="A." surname="Cargille"></author>
         <author ></author>
         <date month="September" year="1995" />
      </front>
      <seriesInfo name="RFC" value="1845"/>
    </reference>

   <reference anchor="CHUNKING">
      <front>
         <title>SMTP Service Extensions for
                     Transmission of Large and Binary MIME Messages</title>
         <author initials="G," surname="Vaudreuil"></author>
         <date month="December" year="2000" />
      </front>
      <seriesInfo name="RFC" value="3030"/>
    </reference>

   <reference anchor="CODES-EXTENSION">
      <front>
         <title>SMTP Service Extension for Returning
                     Enhanced Error Codes</title>
         <author initials="N." surname="Freed"></author>
         <date month="October" year="1996" />
      </front>
      <seriesInfo name="RFC" value="2034"/>
    </reference>

   <reference anchor="DSN">
      <front>
         <title>Simple Mail Transfer Protocol (SMTP)
                     Service Extension for Delivery Status Notifications
                     (DSNs)</title>
         <author initials="K." surname="Moore"></author>
      </front>
      <seriesInfo name="RFC" value="3461"/>
    </reference>

   <reference anchor="ETRN">
      <front>
         <title>SMTP Service Extension for Remote
                     Message Queue Starting</title>
         <author initials="J." surname="De Winter"></author>
         <date month="August" year="1996" />
      </front>
      <seriesInfo name="RFC" value="1985"/>
    </reference>

   <reference anchor="IMAP4">
      <front>
         <title>INTERNET MESSAGE ACCESS PROTOCOL -
                     VERSION 4rev1</title>
         <author initials="M." surname="Crispin"></author>
         <date month="March" year="2003" />
      </front>
      <seriesInfo name="RFC" value="3501"/>
    </reference>

   <reference anchor="IPSEC">
      <front>
         <title>Security Architecture for the Internet Protocol</title>
         <author initials="S." surname="Kent"></author>
         <author initials="K." surname="Seo"></author>
         <date month="December" year="2005" />
      </front>
      <seriesInfo name="RFC" value="4301"/>
    </reference>

   <reference anchor="Msg-Track">
      <front>
         <title>SMTP Service Extension for Message Tracking</title>
         <author initials="E." surname="Allman"></author>
         <author initials="T." surname="Hansen"></author>
         <date month="September" year="2004" />
      </front>
      <seriesInfo name="RFC" value="3885"/>
    </reference>

   <reference anchor="PIPELINING">
      <front>
         <title>SMTP Service Extension for Command
                     Pipelining</title>
         <author initials="N." surname="Freed"></author>
         <date month="September" year="2000" />
      </front>
      <seriesInfo name="RFC" value="2920"/>
	  <seriesInfo name="STD" value="60"/>
    </reference>

   <reference anchor="POP3">
      <front>
         <title>Post Office Protocol -
                     Version 3</title>
         <author initials="J." surname="Myers"></author>
         <author initials="M." surname="Rose"></author>
         <date month="May" year="1996" />
      </front>
      <seriesInfo name="RFC" value="1939"/>
    </reference>

   <reference anchor="SIZE">
      <front>
         <title>SMTP Service
                     Extension for Message Size Declaration</title>
         <author initials="J." surname="Klensin" ></author>
         <author initials="N." surname="Freed"></author>
         <author initials="K." surname="Moore"></author>
         <date month="November" year="1995" />
      </front>
      <seriesInfo name="RFC" value="1870"/>
	  <seriesInfo name="STD" value="10"/>
    </reference>

	<reference anchor="SMTP-CODES">
      <front>
         <title>Enhanced Mail System Status Codes</title>
         <author initials="G," surname="Vaudreuil"></author>
         <date month="January" year="2003" />
      </front>
      <seriesInfo name="RFC" value="3463"/>
    </reference>

   <reference anchor="Start-TLS">
      <front>
         <title>SMTP Service Extension for Secure
                     SMTP over Transport Layer Security</title>
         <author initials="P," surname="Hoffman"></author>
         <author></author>
         <date month="February" year="2002" />
      </front>
      <seriesInfo name="RFC" value="3207"/>
    </reference>

</references>


	  <section title="Major Changes from RFC 4409"
			  anchor="SubstantiveChanges"> 
		 <t> The protocol specified by this document is not
			substantively different from that of RFC 4409.  However,
			the present specification contains several clarifications
			and updates to reflect changes and revisions to other
			documents subsequent to the publication of RFC 4409.  The
			following specific changes may be of interest to some
			readers.</t>
		 <t><list style="symbols">
			<t>Updated several references to reflect more recent
			   versions of the various specifications.  As part of
			   this, reclassified RFC 4954 to a normative reference
			   (SMTP AUTH is a MUST for 4409 and this specification).</t>
			<t>Updated the text in <xref target="SMTP-Interaction"/>
			   to reflect the existence and partial population of the
			   registry and the included table (<xref target="ExtTable"/>) 
			   to correct one entry and add others.  See
			   <xref target="IANAConsid"/> for more information.</t>
			<t>Added new text (<xref target="ShortTimeout"/> to
			   clarify that Submission Servers should respond
			   quickly.</t>
			<t>Added text to make it explicit that character encoding
			   changes are permitted.</t>
			<t> Added text to make it clear that modifications to
			   signed messages may cause problems and that they
			   should be carefully considered.</t> 
	     </list></t>
	  </section>

	  <section title="Note on References" anchor="Stmt4897">
		 <!-- <t>RFC 4897 statement/ disclaimer follows.
			<cref>RFC Editor: please seek advice from the IESG as to
			   whether the statement should be removed for
			   publication.</cref></t>   -->
	  <t>RFCs 4954, 5321, and 5322 are not Full Standards, so their
		 use in citations from this document are downward references
		 (even though the reference to RFC 5322 is a non-normative one).
		 The protocols that they describe are widely-deployed,
		 interoperable, stable, and successful, so the references are
		 justified.</t>
	  </section>
		 
   <section  title="Change Log">
     <t>RFC Editor: Please remove this Section</t>
	   <section title="Changes between RFC 4409 and version-00 of this document">
		  <t>This subsection identifies changes from RFC 4409 to the
			 first posted version of this document that
			 are of an editorial or procedural nature insufficient to
			 justify inclusion in <xref target="SubstantiveChanges"/>
			 or that may need clarification for the WG.
			 <list style="symbols">
				<t>Changed reference identifiers in 4409 that started
				   with numbers to other forms.  Xml2rfc doesn't like
				   leading numbers.</t>
   <!-- specifically, anchors 521REPLY and 8BITMIME were changed to REPLY521 and
	   RFC6152 respectively because the April 2011 version of xml2rfc will
	   not accept the earlier forms as NCNAME identifiers -->
				<t>Added an RFC 4897 downgrade statement as an
				   appendix just in case this goes through on a
				   three-step standards process.</t>
				<t>Started on upgrade of Acknowledgments section.</t>
				<t>Added clarifying language to the first part and
				   last paragraph of Section 8 to be sure that no one
				   thinks the use of an MSA prevents the use of SMTP
				   extensions that extend various permitted properties of
				   messages, or that address rewriting to make message
				   syntax conform to RFC 5321 (or whatever is
				   permitted at the next hop) is prohibited.</t> 
			 </list>
		  </t>
	   </section>
	   <section title="Changes between version -00 and version -01">
		  <t><list style="symbols">
		  <t> Modified <xref target="ResolveAliases"/> to reflect an
			 issue with aliases discussed on the YAM list.
			 <vspace blankLines="1"/>
			 Editor's note: A
			 perfect solution to the alias issue in this document
			 would require complete clarity about what the alias
			 prohibition of RFC 5321 means, especially for a few edge
			 cases.  Lest we end up with inconsistencies down the
			 line, that is really an issue for  RFC 5321bis, not this
			 specification.  The new text at least makes it clear that
			 5321 is the authority.</t>
		  <t> Fixed a typographical error in the contact
			 information.</t>
		  </list></t>
	   </section>	  
	   <section title="Changes between version -01 and version -02">
		  <t><list style="symbols">
			 <t>Several small editorial and style corrections.</t>
			 <t>Explicit notes to RFC Editor about formatting of the
				table and updating the DKIM references.</t>
			 <t>Added a note about Start TLS per posting from Chris
				Newman.</t>
			 <t>New text about timeouts as discussed in the WG meeting
				at IETF 81.</t>
		  </list></t>
	   </section>
	   <section title="Changes between version -02 and version -03">
		  <t>Version -03 was posted to address changes requested by
			 IESG members during their review after IETF Last Call.</t>
		  <t><list style="symbols">
			 <t>Modified the RFC 4897 statement
				(xref target="Stmt4897"/>) to note, for the benefit of
				those who haven't actually read all of the provisions
				of RFC 4897, that 5322 is only informative in this
				document.  Also modified the 
				Appendix to make it more suitable for publication.</t>
			 <t>Removed a citation of SMTP from the Abstract and added
				it to the Introduction.</t>
			 <t>An annotation about a possible revision in progress
				has been added to the reference for RFC 5321.  This is
				similar to the earlier one associated with RFC 5322
				except that the one for 5321 also contains
				instructions to update the 4897 list (Appendix B).</t>
			 <t>Rewritten, more precise, IANA Considerations section
				inserted, replacing most of the old one.</t>
			 <t>Removed a useless explanation from
				<xref target="DocConventions"/>.</t>
			 <t>Replaced the "digital
				signature" text in <xref target="MsgMods"/>.</t>
			 <t>Tuned acknowlegments.</t>
		  </list></t>
	   </section>
			 
   </section>  

     </back>
  </rfc>
     